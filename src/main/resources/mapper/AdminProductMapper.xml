<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coding24h.mall_spring.mapper.AdminProductMapper">

    <resultMap id="ProductResultMap" type="com.coding24h.mall_spring.entity.Product">
        <id property="productId" column="product_id"/>
        <result property="sellerId" column="seller_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="categoryId" column="category_id"/>
        <result property="price" column="price"/>
        <result property="originalPrice" column="original_price"/>
        <result property="condition" column="condition"/>
        <result property="stock" column="stock"/>
        <result property="status" column="status"/>
        <result property="viewCount" column="view_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="isRecommended" column="is_recommended"/>
        <result property="location" column="location"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="imageUrl" column="imageUrl"/>
    </resultMap>

    <select id="findProducts" resultMap="ProductResultMap" parameterType="com.coding24h.mall_spring.dto.ProductQueryDTO">
        SELECT
        p.*,
        <!-- ↓↓↓ 关键：使用子查询来获取主图URL -->
        (SELECT image_url FROM product_images pi
        WHERE pi.product_id = p.product_id
        ORDER BY pi.is_main DESC, pi.sort_order ASC
        LIMIT 1) AS imageUrl
        FROM products p
        <where>
            <if test="title != null and title != ''">
                AND (p.title LIKE CONCAT('%', #{title}, '%')
                OR p.product_id LIKE CONCAT('%', #{title}, '%')
                OR p.seller_id LIKE CONCAT('%', #{title}, '%'))
            </if>
            <if test="categoryId != null and categoryId != ''">
                AND p.category_id = #{categoryId}
            </if>
            <if test="status != null and status != ''">
                AND p.status = #{status}
            </if>
        </where>
        ORDER BY p.created_at DESC
    </select>


    <select id="findById" resultMap="ProductResultMap">
        SELECT * FROM products WHERE product_id = #{productId}
    </select>

    <insert id="insertProduct" useGeneratedKeys="true" keyProperty="productId" parameterType="com.coding24h.mall_spring.entity.Product">
        INSERT INTO products
        (seller_id, title, description, category_id, price, original_price, `condition`, stock, status, is_recommended, location, created_at, updated_at)
        VALUES
            (#{sellerId}, #{title}, #{description}, #{categoryId}, #{price}, #{originalPrice}, #{condition}, #{stock}, #{status}, #{isRecommended}, #{location}, #{createdAt}, #{updatedAt})
    </insert>

    <update id="updateProduct" parameterType="com.coding24h.mall_spring.entity.Product">
        UPDATE products
        <set>
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="price != null">price = #{price},</if>
            <if test="originalPrice != null">original_price = #{originalPrice},</if>
            <if test="condition != null">`condition` = #{condition},</if>
            <if test="stock != null">stock = #{stock},</if>
            <if test="status != null">status = #{status},</if>
            <if test="isRecommended != null">is_recommended = #{isRecommended},</if>
            <if test="location != null">location = #{location},</if>
            updated_at = #{updatedAt}
        </set>
        WHERE product_id = #{productId}
    </update>

    <delete id="deleteProduct">
        DELETE FROM products WHERE product_id = #{productId}
    </delete>






    <!-- CHANGE: 添加一个 ResultMap 来解决映射问题 -->
    <resultMap id="ImageForReviewResultMap" type="com.coding24h.mall_spring.dto.ImageForReviewDTO">
        <id property="imageId" column="image_id"/>
        <result property="productId" column="product_id"/>
        <result property="productTitle" column="product_title"/>
        <result property="imageUrl" column="image_url"/>
        <result property="createdAt" column="created_at"/>
        <result property="verificationStatus" column="verification_status"/>
        <result property="rejectionReason" column="rejection_reason"/>
    </resultMap>

    <!-- CHANGE: 使用 resultMap 替代 resultType -->
    <select id="findImagesByStatus" resultMap="ImageForReviewResultMap">
        SELECT
        pi.image_id,
        pi.product_id,
        p.title AS product_title,
        pi.image_url,
        pi.created_at,
        pi.verification_status,
        pi.rejection_reason
        FROM
        product_images pi
        JOIN
        products p ON pi.product_id = p.product_id
        WHERE
        pi.verification_status = #{status}
        <!-- 新增: 动态SQL，当query不为空时，添加搜索条件 -->
        <if test="query != null and query != ''">
            AND (
            pi.product_id LIKE CONCAT('%', #{query}, '%') OR
            p.title LIKE CONCAT('%', #{query}, '%') OR
            pi.image_id LIKE CONCAT('%', #{query}, '%')
            )
        </if>
        ORDER BY
        pi.created_at DESC
    </select>

    <update id="updateImageReviewStatus">
        UPDATE product_images
        SET
            verification_status = #{status},
            rejection_reason = #{reason}
        WHERE
            image_id = #{imageId}
    </update>

    <select id="findProductIdByImageId" resultType="java.lang.Integer">
        SELECT product_id FROM product_images WHERE image_id = #{imageId}
    </select>

    <select id="countPendingImagesForProduct" resultType="int">
        SELECT COUNT(*) FROM product_images WHERE product_id = #{productId} AND verification_status = 0
    </select>

    <select id="countApprovedImagesForProduct" resultType="int">
        SELECT COUNT(*) FROM product_images WHERE product_id = #{productId} AND verification_status = 1
    </select>

</mapper>
