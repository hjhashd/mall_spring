<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.coding24h.mall_spring.mapper.community.CommunityPostMapper">

    <resultMap id="CommunityPostMap" type="com.coding24h.mall_spring.entity.community.CommunityPost">
        <id column="post_id" property="postId"/>
        <result column="user_id" property="userId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="category" property="category"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="featured_image" property="featuredImage"/>
        <result column="tags" property="tags"/>
        <!-- 关联用户信息 -->
        <association property="user" javaType="com.coding24h.mall_spring.entity.User">
            <id column="user_id" property="userId"/>
            <result column="username" property="username"/>
            <result column="avatar_path" property="avatarPath"/>
        </association>
    </resultMap>

    <select id="selectPostsByFilters" resultMap="CommunityPostMap">
        SELECT
        cp.*,
        u.username,
        u.avatar_path
        FROM community_posts cp
        JOIN users u ON cp.user_id = u.user_id
        <where>
            <if test="category != null and category != ''">
                AND cp.category = #{category}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (cp.title LIKE CONCAT('%', #{keyword}, '%') OR cp.content LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <if test="minLikes != null">
                AND cp.like_count >= #{minLikes}
            </if>
            AND cp.status = 1
        </where>
        ORDER BY cp.created_at DESC
    </select>

    <select id="selectPostById" resultMap="CommunityPostMap">
        SELECT
            cp.*,
            u.username,
            u.avatar_path
        FROM community_posts cp
                 JOIN users u ON cp.user_id = u.user_id
        WHERE cp.post_id = #{postId}
    </select>

    <insert id="insertPost" parameterType="com.coding24h.mall_spring.entity.community.CommunityPost" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO community_posts (user_id, title, content, category, featured_image, tags)
        VALUES (#{userId}, #{title}, #{content}, #{category}, #{featuredImage}, #{tags})
    </insert>

</mapper>
