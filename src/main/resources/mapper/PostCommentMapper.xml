<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.coding24h.mall_spring.mapper.community.PostCommentMapper">

    <resultMap id="PostCommentMap" type="com.coding24h.mall_spring.entity.community.PostComment">
        <id column="comment_id" property="commentId"/>
        <result column="post_id" property="postId"/>
        <result column="user_id" property="userId"/>
        <result column="content" property="content"/>
        <result column="parent_comment_id" property="parentCommentId"/>
        <result column="like_count" property="likeCount"/>
        <result column="created_at" property="createdAt"/>
        <result column="is_author" property="isAuthor"/>
        <!-- 关联用户信息 -->
        <association property="user" javaType="com.coding24h.mall_spring.entity.User">
            <id column="user_id" property="userId"/>
            <result column="username" property="username"/>
            <result column="avatar_path" property="avatarPath"/>
        </association>
    </resultMap>

    <select id="selectCommentsByPostId" resultMap="PostCommentMap">
        SELECT pc.*, u.username, u.avatar_path
        FROM post_comments pc
                 JOIN users u ON pc.user_id = u.user_id
        WHERE pc.post_id = #{postId}
        ORDER BY pc.created_at ASC
    </select>

    <insert id="insertComment" parameterType="com.coding24h.mall_spring.entity.community.PostComment" useGeneratedKeys="true" keyProperty="commentId">
        INSERT INTO post_comments (post_id, user_id, content)
        VALUES (#{postId}, #{userId}, #{content})
    </insert>

    <update id="updatePostCommentCount">
        UPDATE community_posts
        SET comment_count = (SELECT count(*) FROM post_comments WHERE post_id = #{postId})
        WHERE post_id = #{postId}
    </update>

</mapper>
